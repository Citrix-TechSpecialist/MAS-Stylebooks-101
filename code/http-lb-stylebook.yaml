#########
# Header
#########
name: basic-lb-config                            
description: "A simple LB configuration."
display-name: "LB StyleBook (HTTP)"
author: "Mike Smith"
namespace: com.example.stylebooks
schema-version: "1.0"
version: "0.1"

##########
# Imports
##########
import-stylebooks:
  -
    namespace: netscaler.nitro.config
    prefix: ns
    version: "10.5"

###################
# Input Parameters
###################
parameters:
  -
    name: name
    type: string
    label: Application Name
    description: Name of the application configuration.
    required: true
  -
    name: ip
    type: ipaddress
    label: Application Virtual IP (VIP)
    description: Application VIP that the clients access.
    required: true
  -
    name: lb-alg
    type: string
    label: LoadBalancing Algorithm 
    description: Choose the load balancing method for LB client requests.
    allowed-values:   
        - ROUNDROBIN
        - LEASTCONNECTION
    default: ROUNDROBIN
  -
    name: svc-servers
    type: object[]
    label: Application Server IPs
    description: The IP addresses of all the servers of this application
    required: true
    parameters:
      - 
        name: ip
        label: IP Address of the Server
        description: IP Address of the Server
        type: ipaddress
        required: true
      - 
        name: svc-name
        label: Name of the service
        description: Name of the service
        type: string
        required: true
  -
    name: svc-port
    type: tcp-port
    label: Server Port
    description: The TCP port open on the Application Servers to receive requests.
    default: 80

#############
# Components
#############
components:
  -
    name: lbvserver-comp
    type: ns::lbvserver
    description: A Builtin Nitro StyleBook to build lbvserver object.
    properties:
      name: $parameters.name
      servicetype: SSL
      ipv46: $parameters.ip
      port: 80
      lbmethod: $parameters.lb-alg
    components:
      -
        name: svc-comp
        type: ns::service
        repeat: $parameters.svc-servers
        repeat-item: srv
        properties:
          name: svc- + str($srv.svc-name)
          servicetype: HTTP
          ip: $srv.ip
          port: $parameters.svc-port
        components:
          -
            name: member-bind
            type: ns::lbvserver_service_binding
            properties:
              name: $parent.parent.properties.name
              servicename: $parent.properties.name

##########
# Outputs
##########              
outputs:
  -
    name: lbvserver-comp
    value: $components.lbvserver-comp
    description: The component that builds the Nitro lbvserver configuration object